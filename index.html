<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/svg+xml" href="/darth-vader.svg" />
    <title>Star Wars</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="container mt-5">
      <h1 class="text-center mb-4">Star Wars Characters</h1>

      <input
        id="search"
        type="search"
        class="form-control mb-4"
        placeholder="R2-D2"
      />

      <table class="table table-bordered table-responsive">
        <thead class="table-warning">
          <tr>
            <th>Name</th>
            <th>Gender</th>
            <th>Birth Year</th>
            <th>Homeworld</th>
          </tr>
        </thead>
        <tbody id="characterTable"></tbody>
      </table>

      <div
        class="modal fade"
        id="homeworldModal"
        tabindex="-1"
        role="dialog"
        aria-labelledby="homeworldModalTitle"
        aria-hidden="true"
      >
        <div class="modal-dialog modal-dialog-centered" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="homeworldModalTitle">
                Homeworld Details
              </h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>
            <div class="modal-body" id="homeworldModalBody"></div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                Close
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      const API_URL = "https://swapi.info/api/people";

      async function fetchCharacters() {
        try {
          const response = await fetch(API_URL);
          const characters = await response.json();

          const randomIndexes = new Set();

          while (randomIndexes.size < 5) {
            randomIndexes.add(Math.floor(Math.random() * characters.length));
          }

          const randomCharacters = Array.from(randomIndexes).map(
            (index) => characters[index]
          );
          populateTable(randomCharacters);
        } catch (error) {
          console.error("Error fetching characters:", error);
        }
      }

      function populateTable(characters) {
        const tableBody = document.getElementById("characterTable");

        characters.forEach((character) => {
          const row = document.createElement("tr");

          row.innerHTML = `
          <td>${character.name}</td>
          <td>${character.gender}</td>
          <td>${character.birth_year}</td>
          <td>
          <button
              class="btn btn-sm btn-warning"
              data-toggle="modal"
              data-target="#homeworldModal"
              data-homeworld="${character.homeworld}">
              View Homeworld
          </button>
          </td>
        `;

          tableBody.appendChild(row);
        });

        attachPopoverHandlers();
      }

      function attachPopoverHandlers() {
        document.querySelectorAll("[data-homeworld]").forEach((button) => {
          button.addEventListener("click", async (event) => {
            const homeworldUrl = event.target.getAttribute("data-homeworld");
            const modalBody = document.getElementById("homeworldModalBody");
            const modalElement = document.querySelector(".modal");

            const modal = new bootstrap.Modal(modalElement);
            modal.show();

            try {
              const response = await fetch(homeworldUrl);
              const homeworld = await response.json();

              modalBody.innerHTML = `
              <p><strong>Name:</strong> ${homeworld.name}</p><br>
              <p><strong>Climate:</strong> ${homeworld.climate}</p><br>
              <p><strong>Terrain:</strong> ${homeworld.terrain}</p><br>
              <p><strong>Population:</strong> ${homeworld.population}</p>
            `;
            } catch (error) {
              modalBody.innerHTML = `<p class="text-danger">Failed to load homeworld details.</p>`;
              console.error("Error fetching homeworld:", error);
            }
          });
        });
      }

      document.getElementById("search").addEventListener("input", (event) => {
        const filter = event.target.value.trim().toLowerCase();
        document.querySelectorAll("#characterTable tr").forEach((row) => {
          const name = row.cells[0].textContent.toLowerCase();

          row.style.display = name.includes(filter) ? "" : "none";
        });
      });

      fetchCharacters();
    </script>
  </body>
</html>
